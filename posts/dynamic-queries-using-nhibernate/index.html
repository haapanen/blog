<!DOCTYPE html>
<html lang="en" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>Dynamic queries using NHibernate with the help of C# expression trees | Jussi&#39;s Blog</title>
<meta name="keywords" content="">
<meta name="description" content="I had to recently figure out a way to query database objects based on user input without knowing beforehand which classes user wants to query. Basically user would input a type and the system would find it’s child types from a database table. The children would then be fetched based on a set of rules (we do not want all items on the table, just the ones linked to the parent).">
<meta name="author" content="Jussi Haapanen">
<link rel="canonical" href="https://jussihaapanen.com/posts/dynamic-queries-using-nhibernate/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.5fe57f96e8bd4b053150e97725ce1ee64f04ecd17ce2a1eca44fefb55c62ceb3.css" integrity="sha256-X&#43;V/lui9SwUxUOl3Jc4e5k8E7NF84qHspE/vtVxizrM=" rel="preload stylesheet" as="style">
<link rel="icon" href="https://jussihaapanen.com/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="https://jussihaapanen.com/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="https://jussihaapanen.com/favicon-32x32.png">
<link rel="apple-touch-icon" href="https://jussihaapanen.com/apple-touch-icon.png">
<link rel="mask-icon" href="https://jussihaapanen.com/safari-pinned-tab.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<link rel="alternate" hreflang="en" href="https://jussihaapanen.com/posts/dynamic-queries-using-nhibernate/">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --code-block-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript><meta property="og:title" content="Dynamic queries using NHibernate with the help of C# expression trees" />
<meta property="og:description" content="I had to recently figure out a way to query database objects based on user input without knowing beforehand which classes user wants to query. Basically user would input a type and the system would find it’s child types from a database table. The children would then be fetched based on a set of rules (we do not want all items on the table, just the ones linked to the parent)." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://jussihaapanen.com/posts/dynamic-queries-using-nhibernate/" />
<meta property="og:image" content="https://jussihaapanen.com/images/avatar.jpg" />
<meta property="article:section" content="posts" />
<meta property="article:published_time" content="2017-02-05T00:00:00+03:00" />
<meta property="article:modified_time" content="2017-02-05T00:00:00+03:00" />

<meta name="twitter:card" content="summary_large_image" />
<meta name="twitter:image" content="https://jussihaapanen.com/images/avatar.jpg" />
<meta name="twitter:title" content="Dynamic queries using NHibernate with the help of C# expression trees"/>
<meta name="twitter:description" content="I had to recently figure out a way to query database objects based on user input without knowing beforehand which classes user wants to query. Basically user would input a type and the system would find it’s child types from a database table. The children would then be fetched based on a set of rules (we do not want all items on the table, just the ones linked to the parent)."/>


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "Posts",
      "item": "https://jussihaapanen.com/posts/"
    }, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "Dynamic queries using NHibernate with the help of C# expression trees",
      "item": "https://jussihaapanen.com/posts/dynamic-queries-using-nhibernate/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "Dynamic queries using NHibernate with the help of C# expression trees",
  "name": "Dynamic queries using NHibernate with the help of C# expression trees",
  "description": "I had to recently figure out a way to query database objects based on user input without knowing beforehand which classes user wants to query. Basically user would input a type and the system would find it’s child types from a database table. The children would then be fetched based on a set of rules (we do not want all items on the table, just the ones linked to the parent).\n",
  "keywords": [
    
  ],
  "articleBody": "I had to recently figure out a way to query database objects based on user input without knowing beforehand which classes user wants to query. Basically user would input a type and the system would find it’s child types from a database table. The children would then be fetched based on a set of rules (we do not want all items on the table, just the ones linked to the parent).\nThere was a “no raw SQL” limitation on the project and I had the data model mapped as NHibernate classes so my initial idea was to use reflection to match the inputted class name with the actual NHibernate class (e.g. user input of MyClass would be mapped to Foo.Bar.MyClass) and then use NHibernate session to simply query for the objects. This would also let me easily verify that the database actually contains the specific model as I could just find the mapping class for the object type based on the NHibernate mapping class convention (e.g. MyClassMap, YourClassMap). If there was no map, there was no table on the database meaning the user input was invalid.\nIt was a fairly simple process to do the initial input to object type mapping and simply querying the objects. I was quickly able to fetch a list of objects in the database based on just the type. Basically NHibernate let’s you query objects by type name string and specifying the return type as an “object”.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 // NHibernate entities are stored in a single assembly // Get all classes from the assembly that MyClass is in var entities = Assembly.GetAssembly(typeof(MyClass)) .GetTypes() .Where(x =\u003e x.IsClass) .ToList(); // Input from user var objectTypeName = \"MyClass\"; // See if the type actually exists var objectType = entities .SingleOrDefault(x =\u003e x.FullName.Split('.').Last() == objectTypeName); // Check if object type was actually found if (objectType == null) { // Input isn't valid throw ... } // We need to fetch as \"object\" as we do not know the type // compile time. // We'll pass the object type name as a parameter to tell NHibernate // what the type actually is. // NHibernate session should be opened before var objects = session.Query\u003cobject\u003e(objectType.FullName); I could then use reflection to access properties of the actual type:\n1 2 3 4 5 6 7 // An object taken from the result set from a session.Query call var someObject = objects.FirstOrDefault(); // Read the value of someObject.SomeProperty var value = objectType .GetProperty(\"SomeProperty\") .GetValue(someObject, null); Console.WriteLine(value); While it was simple to query all objects in the database the next issue was a bit more puzzling for me. Previously I’ve used Fluent NHibernate to do the queries with LINQ but I couldn’t do that anymore in the same exact way as I didn’t know which fields I would have to use for filtering. The fields weren’t same for each class either. I couldn’t use reflection for the filtering as that’d mean I’d have to read all objects from a single table into memory and do the filtering there.\nAfter some searching I figured out C# expression trees are probably the feature I’m looking for. LINQ queries are based on them after all. I was quickly able to find some examples about how other’s have used them to implement dynamic queries. I wanted to include objects where SomeProperty contained the text I was looking for. I ended up with code like this:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 var item = Expression.Parameter(typeof(object), \"item\"); // Where(item =\u003e item.SomeProperty) var property = Expression.Property(item, \"SomeProperty\"); // Where(item =\u003e item.SomeProperty.Contains) var containsMethod = typeof(string) .GetMethod(\"Contains\", new[]{typeof(string)); // What we're searching for (e.g. SomeProperty.Contains(\"foo\")) var searchExpression = Expression.Constant(\"foo\", typeof(string)); // Call the \"Contains\" method for the \"SomeProperty\" with // searchExpression as the constant to compare with var methodExpression = Expression .Call(property, containsMethod, searchExpression); // Create a lambda to use inside the where call var lambda = Expression.Lambda\u003cFunc\u003cobject, bool\u003e\u003e(methodExpression, item); // Do the query with the expression var objects = session .Query\u003cobject\u003e(objectType.FullName).Where(lambda); I ran into a problem with this. “object” doesn’t have a property of “SomeProperty”. I tried to switch the type in the Expression.Parameter call to typeof(objectType) but then the lambda would fail as the types didn’t match. I couldn’t change the lambda type (e.g. Func) as generics require a compile time type definition. All of the examples I was able to find always knew the object type on compile time. Took me some time to figure it out but the fix was fairly simple in the end. All I had to do was convert the type of “item” to the correct type in the Expression.Property call.\n1 2 3 4 // Where(item =\u003e item.SomeProperty) var property = Expression .Property(Expression.Convert(item, objectType), \"SomeProperty\"); So the code would end up looking like this:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 // Declare the parameter we're accessing var item = Expression.Parameter(typeof(object), \"item\"); // Where(item =\u003e item) var property = Expression .Property( Expression.Convert(item, objectType), \"SomeProperty\" ); // Where(item =\u003e item.Contains) var containsMethod = typeof(string) .GetMethod(\"Contains\", new[] {typeof(string)}); // Where(item =\u003e item.Contains(\"foo\")) var searchExpression = Expression.Constant(\"foo\", typeof(string)); // Call the \"Contains\" method for the \"SomeProperty\" var methodExpression = Expression .Call(property, method, searchExpression); // Wrap the method into a lambda var lambda = Expression .Lambda\u003cFunc\u003cobject, bool\u003e\u003e(methodExpression, item); // Do the NHibernate search with the lambda var result = session.Query\u003cobject\u003e(objectType.FullName) .Where(lambda); I could now replace the constants “SomeProperty” and “foo” with a variable and make it possible to do dynamic queries based on user input.\nThis was a rather short but very interesting peek into the internals of LINQ queries. C# expression trees are a powerful feature that let you do complex things that just aren’t possible using LINQ.\n",
  "wordCount" : "989",
  "inLanguage": "en",
  "image": "https://jussihaapanen.com/images/avatar.jpg","datePublished": "2017-02-05T00:00:00+03:00",
  "dateModified": "2017-02-05T00:00:00+03:00",
  "author":{
    "@type": "Person",
    "name": "Jussi Haapanen"
  },
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://jussihaapanen.com/posts/dynamic-queries-using-nhibernate/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "Jussi's Blog",
    "logo": {
      "@type": "ImageObject",
      "url": "https://jussihaapanen.com/favicon.ico"
    }
  }
}
</script>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="https://jussihaapanen.com/" accesskey="h" title="Jussi&#39;s Blog (Alt + H)">Jussi&#39;s Blog</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="https://jussihaapanen.com/posts/" title="Posts">
                    <span>Posts</span>
                </a>
            </li>
            <li>
                <a href="https://jussihaapanen.com/search/" title="Search (Alt &#43; /)" accesskey=/>
                    <span>Search</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    <div class="breadcrumbs"><a href="https://jussihaapanen.com/">Home</a>&nbsp;»&nbsp;<a href="https://jussihaapanen.com/posts/">Posts</a></div>
    <h1 class="post-title entry-hint-parent">
      Dynamic queries using NHibernate with the help of C# expression trees
    </h1>
    <div class="post-meta"><span title='2017-02-05 00:00:00 +0300 +0300'>February 5, 2017</span>&nbsp;·&nbsp;5 min&nbsp;·&nbsp;Jussi Haapanen

</div>
  </header> 

  <div class="post-content"><p>I had to recently figure out a way to query database objects based on user input without knowing beforehand which classes user wants to query. Basically user would input a type and the system would find it’s child types from a database table. The children would then be fetched based on a set of rules (we do not want all items on the table, just the ones linked to the parent).</p>
<p>There was a “no raw SQL” limitation on the project and I had the data model mapped as NHibernate classes so my initial idea was to use reflection to match the inputted class name with the actual NHibernate class (e.g. user input of MyClass would be mapped to Foo.Bar.MyClass) and then use NHibernate session to simply query for the objects. This would also let me easily verify that the database actually contains the specific model as I could just find the mapping class for the object type based on the NHibernate mapping class convention (e.g. MyClassMap, YourClassMap). If there was no map, there was no table on the database meaning the user input was invalid.</p>
<p>It was a fairly simple process to do the initial input to object type mapping and simply querying the objects. I was quickly able to fetch a list of objects in the database based on just the type. Basically NHibernate let’s you query objects by type name string and specifying the return type as an “object”.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-csharp" data-lang="csharp"><span class="line"><span class="cl"><span class="c1">// NHibernate entities are stored in a single assembly</span>
</span></span><span class="line"><span class="cl"><span class="c1">// Get all classes from the assembly that MyClass is in</span>
</span></span><span class="line"><span class="cl"><span class="kt">var</span> <span class="n">entities</span> <span class="p">=</span> <span class="n">Assembly</span><span class="p">.</span><span class="n">GetAssembly</span><span class="p">(</span><span class="k">typeof</span><span class="p">(</span><span class="n">MyClass</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">  <span class="p">.</span><span class="n">GetTypes</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">  <span class="p">.</span><span class="n">Where</span><span class="p">(</span><span class="n">x</span> <span class="p">=&gt;</span> <span class="n">x</span><span class="p">.</span><span class="n">IsClass</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="p">.</span><span class="n">ToList</span><span class="p">();</span>
</span></span><span class="line"><span class="cl"><span class="c1">// Input from user</span>
</span></span><span class="line"><span class="cl"><span class="kt">var</span> <span class="n">objectTypeName</span> <span class="p">=</span> <span class="s">&#34;MyClass&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="c1">// See if the type actually exists</span>
</span></span><span class="line"><span class="cl"><span class="kt">var</span> <span class="n">objectType</span> <span class="p">=</span> <span class="n">entities</span>
</span></span><span class="line"><span class="cl">  <span class="p">.</span><span class="n">SingleOrDefault</span><span class="p">(</span><span class="n">x</span> <span class="p">=&gt;</span> <span class="n">x</span><span class="p">.</span><span class="n">FullName</span><span class="p">.</span><span class="n">Split</span><span class="p">(</span><span class="sc">&#39;.&#39;</span><span class="p">).</span><span class="n">Last</span><span class="p">()</span> <span class="p">==</span> <span class="n">objectTypeName</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="c1">// Check if object type was actually found</span>
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="p">(</span><span class="n">objectType</span> <span class="p">==</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// Input isn&#39;t valid</span>
</span></span><span class="line"><span class="cl">  <span class="k">throw</span> <span class="p">...</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="c1">// We need to fetch as &#34;object&#34; as we do not know the type</span>
</span></span><span class="line"><span class="cl"><span class="c1">// compile time.</span>
</span></span><span class="line"><span class="cl"><span class="c1">// We&#39;ll pass the object type name as a parameter to tell NHibernate</span>
</span></span><span class="line"><span class="cl"><span class="c1">// what the type actually is.</span>
</span></span><span class="line"><span class="cl"><span class="c1">// NHibernate session should be opened before</span>
</span></span><span class="line"><span class="cl"><span class="kt">var</span> <span class="n">objects</span> <span class="p">=</span> <span class="n">session</span><span class="p">.</span><span class="n">Query</span><span class="p">&lt;</span><span class="kt">object</span><span class="p">&gt;(</span><span class="n">objectType</span><span class="p">.</span><span class="n">FullName</span><span class="p">);</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>I could then use reflection to access properties of the actual type:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-csharp" data-lang="csharp"><span class="line"><span class="cl"><span class="c1">// An object taken from the result set from a session.Query call</span>
</span></span><span class="line"><span class="cl"><span class="kt">var</span> <span class="n">someObject</span> <span class="p">=</span> <span class="n">objects</span><span class="p">.</span><span class="n">FirstOrDefault</span><span class="p">();</span>
</span></span><span class="line"><span class="cl"><span class="c1">// Read the value of someObject.SomeProperty</span>
</span></span><span class="line"><span class="cl"><span class="kt">var</span> <span class="k">value</span> <span class="p">=</span> <span class="n">objectType</span>
</span></span><span class="line"><span class="cl">  <span class="p">.</span><span class="n">GetProperty</span><span class="p">(</span><span class="s">&#34;SomeProperty&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="p">.</span><span class="n">GetValue</span><span class="p">(</span><span class="n">someObject</span><span class="p">,</span> <span class="kc">null</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="k">value</span><span class="p">);</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>While it was simple to query all objects in the database the next issue was a bit more puzzling for me. Previously I’ve used Fluent NHibernate to do the queries with LINQ but I couldn’t do that anymore in the same exact way as I didn’t know which fields I would have to use for filtering. The fields weren’t same for each class either. I couldn’t use reflection for the filtering as that’d mean I’d have to read all objects from a single table into memory and do the filtering there.</p>
<p>After some searching I figured out C# expression trees are probably the feature I’m looking for. LINQ queries are based on them after all. I was quickly able to find some examples about how other’s have used them to implement dynamic queries. I wanted to include objects where SomeProperty contained the text I was looking for. I ended up with code like this:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-csharp" data-lang="csharp"><span class="line"><span class="cl"><span class="kt">var</span> <span class="n">item</span> <span class="p">=</span> <span class="n">Expression</span><span class="p">.</span><span class="n">Parameter</span><span class="p">(</span><span class="k">typeof</span><span class="p">(</span><span class="kt">object</span><span class="p">),</span> <span class="s">&#34;item&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="c1">// Where(item =&gt; item.SomeProperty)</span>
</span></span><span class="line"><span class="cl"><span class="kt">var</span> <span class="n">property</span> <span class="p">=</span> <span class="n">Expression</span><span class="p">.</span><span class="n">Property</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="s">&#34;SomeProperty&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="c1">// Where(item =&gt; item.SomeProperty.Contains)</span>
</span></span><span class="line"><span class="cl"><span class="kt">var</span> <span class="n">containsMethod</span> <span class="p">=</span> <span class="k">typeof</span><span class="p">(</span><span class="kt">string</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="p">.</span><span class="n">GetMethod</span><span class="p">(</span><span class="s">&#34;Contains&#34;</span><span class="p">,</span> <span class="k">new</span><span class="p">[]{</span><span class="k">typeof</span><span class="p">(</span><span class="kt">string</span><span class="p">));</span>
</span></span><span class="line"><span class="cl"><span class="c1">// What we&#39;re searching for (e.g. SomeProperty.Contains(&#34;foo&#34;))</span>
</span></span><span class="line"><span class="cl"><span class="kt">var</span> <span class="n">searchExpression</span> <span class="p">=</span> <span class="n">Expression</span><span class="p">.</span><span class="n">Constant</span><span class="p">(</span><span class="s">&#34;foo&#34;</span><span class="p">,</span> <span class="k">typeof</span><span class="p">(</span><span class="kt">string</span><span class="p">));</span>
</span></span><span class="line"><span class="cl"><span class="c1">// Call the &#34;Contains&#34; method for the &#34;SomeProperty&#34; with</span>
</span></span><span class="line"><span class="cl"><span class="c1">// searchExpression as the constant to compare with</span>
</span></span><span class="line"><span class="cl"><span class="kt">var</span> <span class="n">methodExpression</span> <span class="p">=</span> <span class="n">Expression</span>
</span></span><span class="line"><span class="cl">  <span class="p">.</span><span class="n">Call</span><span class="p">(</span><span class="n">property</span><span class="p">,</span> <span class="n">containsMethod</span><span class="p">,</span> <span class="n">searchExpression</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="c1">// Create a lambda to use inside the where call</span>
</span></span><span class="line"><span class="cl"><span class="kt">var</span> <span class="n">lambda</span> <span class="p">=</span> <span class="n">Expression</span><span class="p">.</span><span class="n">Lambda</span><span class="p">&lt;</span><span class="n">Func</span><span class="p">&lt;</span><span class="kt">object</span><span class="p">,</span> <span class="kt">bool</span><span class="p">&gt;&gt;(</span><span class="n">methodExpression</span><span class="p">,</span> <span class="n">item</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="c1">// Do the query with the expression</span>
</span></span><span class="line"><span class="cl"><span class="kt">var</span> <span class="n">objects</span> <span class="p">=</span> <span class="n">session</span>
</span></span><span class="line"><span class="cl">  <span class="p">.</span><span class="n">Query</span><span class="p">&lt;</span><span class="kt">object</span><span class="p">&gt;(</span><span class="n">objectType</span><span class="p">.</span><span class="n">FullName</span><span class="p">).</span><span class="n">Where</span><span class="p">(</span><span class="n">lambda</span><span class="p">);</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>I ran into a problem with this. “object” doesn’t have a property of “SomeProperty”. I tried to switch the type in the Expression.Parameter call to typeof(objectType) but then the lambda would fail as the types didn’t match. I couldn’t change the lambda type (e.g. Func&lt;someRuntimeVariable, bool&gt;) as generics require a compile time type definition. All of the examples I was able to find always knew the object type on compile time. Took me some time to figure it out but the fix was fairly simple in the end. All I had to do was convert the type of “item” to the correct type in the Expression.Property call.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-csharp" data-lang="csharp"><span class="line"><span class="cl"><span class="c1">// Where(item =&gt; item.SomeProperty)</span>
</span></span><span class="line"><span class="cl"><span class="kt">var</span> <span class="n">property</span> <span class="p">=</span> <span class="n">Expression</span>
</span></span><span class="line"><span class="cl">  <span class="p">.</span><span class="n">Property</span><span class="p">(</span><span class="n">Expression</span><span class="p">.</span><span class="n">Convert</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">objectType</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">    <span class="s">&#34;SomeProperty&#34;</span><span class="p">);</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>So the code would end up looking like this:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-csharp" data-lang="csharp"><span class="line"><span class="cl"><span class="c1">// Declare the parameter we&#39;re accessing</span>
</span></span><span class="line"><span class="cl"><span class="kt">var</span> <span class="n">item</span> <span class="p">=</span> <span class="n">Expression</span><span class="p">.</span><span class="n">Parameter</span><span class="p">(</span><span class="k">typeof</span><span class="p">(</span><span class="kt">object</span><span class="p">),</span> <span class="s">&#34;item&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="c1">// Where(item =&gt; item)</span>
</span></span><span class="line"><span class="cl"><span class="kt">var</span> <span class="n">property</span> <span class="p">=</span> <span class="n">Expression</span>
</span></span><span class="line"><span class="cl">  <span class="p">.</span><span class="n">Property</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="n">Expression</span><span class="p">.</span><span class="n">Convert</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">objectType</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">    <span class="s">&#34;SomeProperty&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="c1">// Where(item =&gt; item.Contains)</span>
</span></span><span class="line"><span class="cl"><span class="kt">var</span> <span class="n">containsMethod</span> <span class="p">=</span> <span class="k">typeof</span><span class="p">(</span><span class="kt">string</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="p">.</span><span class="n">GetMethod</span><span class="p">(</span><span class="s">&#34;Contains&#34;</span><span class="p">,</span> <span class="k">new</span><span class="p">[]</span> <span class="p">{</span><span class="k">typeof</span><span class="p">(</span><span class="kt">string</span><span class="p">)});</span>
</span></span><span class="line"><span class="cl"><span class="c1">// Where(item =&gt; item.Contains(&#34;foo&#34;))</span>
</span></span><span class="line"><span class="cl"><span class="kt">var</span> <span class="n">searchExpression</span> <span class="p">=</span> <span class="n">Expression</span><span class="p">.</span><span class="n">Constant</span><span class="p">(</span><span class="s">&#34;foo&#34;</span><span class="p">,</span> <span class="k">typeof</span><span class="p">(</span><span class="kt">string</span><span class="p">));</span>
</span></span><span class="line"><span class="cl"><span class="c1">// Call the &#34;Contains&#34; method for the &#34;SomeProperty&#34;</span>
</span></span><span class="line"><span class="cl"><span class="kt">var</span> <span class="n">methodExpression</span> <span class="p">=</span> <span class="n">Expression</span>
</span></span><span class="line"><span class="cl">  <span class="p">.</span><span class="n">Call</span><span class="p">(</span><span class="n">property</span><span class="p">,</span> <span class="n">method</span><span class="p">,</span> <span class="n">searchExpression</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="c1">// Wrap the method into a lambda</span>
</span></span><span class="line"><span class="cl"><span class="kt">var</span> <span class="n">lambda</span> <span class="p">=</span> <span class="n">Expression</span>
</span></span><span class="line"><span class="cl">  <span class="p">.</span><span class="n">Lambda</span><span class="p">&lt;</span><span class="n">Func</span><span class="p">&lt;</span><span class="kt">object</span><span class="p">,</span> <span class="kt">bool</span><span class="p">&gt;&gt;(</span><span class="n">methodExpression</span><span class="p">,</span> <span class="n">item</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="c1">// Do the NHibernate search with the lambda</span>
</span></span><span class="line"><span class="cl"><span class="kt">var</span> <span class="n">result</span> <span class="p">=</span> <span class="n">session</span><span class="p">.</span><span class="n">Query</span><span class="p">&lt;</span><span class="kt">object</span><span class="p">&gt;(</span><span class="n">objectType</span><span class="p">.</span><span class="n">FullName</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="p">.</span><span class="n">Where</span><span class="p">(</span><span class="n">lambda</span><span class="p">);</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>I could now replace the constants “SomeProperty” and “foo” with a variable and make it possible to do dynamic queries based on user input.</p>
<p>This was a rather short but very interesting peek into the internals of LINQ queries. C# expression trees are a powerful feature that let you do complex things that just aren’t possible using LINQ.</p>


  </div>

  <footer class="post-footer">
    <ul class="post-tags">
    </ul>
<nav class="paginav">
  <a class="prev" href="https://jussihaapanen.com/posts/piping-data-in-dotnet-core/">
    <span class="title">« Prev</span>
    <br>
    <span>Piping data to an application in .NET Core</span>
  </a>
</nav>

  </footer>
</article>
    </main>
    
<footer class="footer">
        <span>© Jussi Haapanen</span> · 

    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://github.com/adityatelange/hugo-PaperMod/" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerHTML = 'copy';

        function copyingDone() {
            copybutton.innerHTML = 'copied!';
            setTimeout(() => {
                copybutton.innerHTML = 'copy';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                navigator.clipboard.writeText(codeblock.textContent);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) { };
            selection.removeRange(range);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
        }
    });
</script>
</body>

</html>
